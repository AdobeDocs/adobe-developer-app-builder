"use strict";(self.webpackChunkadobe_developer_app_builder=self.webpackChunkadobe_developer_app_builder||[]).push([[3399],{3249:function(e,t,a){a.r(t),a.d(t,{_frontmatter:function(){return d},default:function(){return p}});var n=a(87462),l=a(63366),r=(a(15007),a(64983)),i=a(91515),m=["components"],d={},o={_frontmatter:d},s=i.Z;function p(e){var t=e.components,a=(0,l.Z)(e,m);return(0,r.mdx)(s,(0,n.Z)({},o,a,{components:t,mdxType:"MDXLayout"}),(0,r.mdx)("h1",{id:"dealing-with-application-state"},"Dealing with Application State"),(0,r.mdx)("p",null,"Application state could be a pre-defined variable of your action that is accessible across all invocations, or dynamic values or files uploaded by the web users when the app is running. App Builder provides the appropriate tools to handle each of these requirements."),(0,r.mdx)("h2",{id:"default-parameters"},"Default parameters"),(0,r.mdx)("p",null,"Sometimes you want to bind the same parameter values for all invocations or you just set default values of your action. In either case, you have two different options: setting params at the action level, or at the package level (so all actions in that package can inherit them). These params are set in the ",(0,r.mdx)("inlineCode",{parentName:"p"},"manifest.yaml")," file, as the following example."),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-yaml"},"hello-world:\n  function: actions/hello/index.js\n  inputs:\n    name: Joe\n")),(0,r.mdx)("p",null,"In many cases, these variables are different depending on the build environment of the app, such as different tenant names in dev, stage, prod, etc. To make it work seamlessly with Git commits, you could store the real value of the variables in the ",(0,r.mdx)("inlineCode",{parentName:"p"},".env")," file (which is not committed to Git), and reference them in the ",(0,r.mdx)("inlineCode",{parentName:"p"},"manifest.yaml")," file."),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-bash"},"# in .env\nNAME=Joe\n")),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-yaml"},"# in manifest.yaml\nhello-world:\n  function: actions/hello/index.js\n  inputs:\n    name: $NAME\n")),(0,r.mdx)("h3",{id:"considerations-about-security"},"Considerations about security"),(0,r.mdx)("p",null,"For authentication with Adobe APIs, you should leverage ",(0,r.mdx)("a",{parentName:"p",href:"security/index.md"},"App Builder Security Guideline")," using our supported SDKs."),(0,r.mdx)("p",null,"For other 3rd party systems and APIs when provisioning actions with the secrets/passwords is a must, you can then use the default params as demonstrated above. In order to support this use case, all default params are automatically encrypted. They are decrypted just before the action code is executed. Thus, the only time you have access to the decrypted value is while executing the action code."),(0,r.mdx)("h2",{id:"persistence-at-runtime"},"Persistence at runtime"),(0,r.mdx)("p",null,"As part of App Builder, you will have out-of-the-box access to ",(0,r.mdx)("em",{parentName:"p"},"Files")," and ",(0,r.mdx)("em",{parentName:"p"},"State"),", our two storage services meant for persisting data dynamically from your Runtime actions."),(0,r.mdx)("p",null,"No pre-configuration is required, just install the libraries and use them in your project. We will be transparently using your App Builder credentials to authorize and entitle your requests."),(0,r.mdx)("p",null,(0,r.mdx)("em",{parentName:"p"},"When should I use Files vs State?")),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},"Files is good for transferring large payloads (bandwidth oriented) and State is good for fast access (latency oriented)."),(0,r.mdx)("li",{parentName:"ul"},"Files supports sharing data via presigned-url, State supports setting expirations."),(0,r.mdx)("li",{parentName:"ul"},"As a rule of thumb if you expect your data to grow larger than 100KBs go with Files, otherwise use State.")),(0,r.mdx)("p",null,"Please refer to the ",(0,r.mdx)("a",{parentName:"p",href:"#feature-matrix"},"feature matrix")," for a detailed comparison."),(0,r.mdx)("h2",{id:"state"},"State"),(0,r.mdx)("p",null,(0,r.mdx)("em",{parentName:"p"},"We've just released a ",(0,r.mdx)("a",{parentName:"em",href:"https://github.com/adobe/aio-lib-state/releases/tag/4.0.0"},"new State version")," built on top of our own storage service. ",(0,r.mdx)("a",{parentName:"em",href:"https://github.com/adobe/aio-lib-state/tree/3.x"},"Legacy State")," (< v4.0, based on CosmosDB) is still available, but we strongly advise new users to use the latest library version to avoid migrating later. We will be sending out migration steps for existing customers soon. The ",(0,r.mdx)("a",{parentName:"em",href:"#feature-matrix"},"feature matrix")," provides a detailed comparison of both versions.")),(0,r.mdx)("p",null,(0,r.mdx)("strong",{parentName:"p"},(0,r.mdx)("em",{parentName:"strong"},"How is my data stored?"))),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},'State is a multi-tenant storage. Your data is isolated in a "State container" which maps to your I/O Runtime namespace and application Workspace. This means that each application Workspace has its own isolated data.'),(0,r.mdx)("li",{parentName:"ul"},"You have the option to store data in either the ",(0,r.mdx)("inlineCode",{parentName:"li"},"amer")," or ",(0,r.mdx)("inlineCode",{parentName:"li"},"emea")," region. These regions operate independently, so treat them as separate instances. You may prefer one region over the other to optimize latency, as it may be closer to your users, or for compliance reasons such as GDPR. ",(0,r.mdx)("em",{parentName:"li"},(0,r.mdx)("inlineCode",{parentName:"em"},"apac")," will be available soon.")),(0,r.mdx)("li",{parentName:"ul"},"Your data is not eternal. There is a configurable time-to-live (TTL) for each key-value pair, the default is 1 day and the maximum is 1 year (365 days).")),(0,r.mdx)("p",null,"Region Acronyms are abbreviations for one or more continents that are part of a business region."),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("inlineCode",{parentName:"li"},"amer"),": North, Central, and South America"),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("inlineCode",{parentName:"li"},"apac"),": Asia and Pacific"),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("inlineCode",{parentName:"li"},"emea"),": Europe, the Middle East, and Africa")),(0,r.mdx)("h3",{id:"getting-started"},"Getting started"),(0,r.mdx)("p",null,(0,r.mdx)("strong",{parentName:"p"},(0,r.mdx)("em",{parentName:"strong"},"Library usage, from an I/O Runtime Action:"))),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-bash"},"npm install @adobe/aio-lib-state\n")),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre",className:"language-js"},"  const stateLib = require('@adobe/aio-lib-state')\n\n  // init with implicit I/O Runtime credentials, default region is 'amer'.\n  const state = await stateLib.init()\n  // set an explicit region\n  const state2 = await stateLib.init({ region: 'emea' })\n\n  // get\n  const res = await state.get('key') // res = { value, expiration }\n  const value = res.value\n  // put\n  await state.put('key', 'value') // with default ttl of 1 day\n  await state.put('another key', 'another value', { ttl: 200 }) // in seconds, use -1 for max (365 days).\n  // delete\n  await state.delete('key')\n\n  // list keys using an iterator, with glob pattern support\n  await for (const { keys } of state.list({ match: 'ke*' })) {\n    console.log(keys)\n  }\n\n  // returns true if you have at least one key and value\n  await state.any()\n  // returns usage statistics (storage)\n  await state.stats()\n\n  // delete all keys and values\n  await state.deleteAll()\n")),(0,r.mdx)("p",null,"Explore the ",(0,r.mdx)("a",{parentName:"p",href:"https://github.com/adobe/aio-lib-state/blob/main/doc/api.md"},"full API")),(0,r.mdx)("p",null,(0,r.mdx)("strong",{parentName:"p"},(0,r.mdx)("em",{parentName:"strong"},"CLI usage, from your local machine")),": ",(0,r.mdx)("em",{parentName:"p"},"coming soon!")),(0,r.mdx)("h3",{id:"limits--validation"},"Limits & validation"),(0,r.mdx)("p",null,"Limits are enforced and can't be changed on a per-user basis."),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},"State is only available to Runtime namespaces created via the Developer Console, which follow the App Builder format: ",(0,r.mdx)("inlineCode",{parentName:"li"},"orgId-project(-workspace)?"),". Legacy namespaces are not supported."),(0,r.mdx)("li",{parentName:"ul"},"Max state value size: ",(0,r.mdx)("inlineCode",{parentName:"li"},"1MB"),"."),(0,r.mdx)("li",{parentName:"ul"},"Max state key size: ",(0,r.mdx)("inlineCode",{parentName:"li"},"1024 bytes"),"."),(0,r.mdx)("li",{parentName:"ul"},"Max-supported TTL is ",(0,r.mdx)("inlineCode",{parentName:"li"},"365 days"),"."),(0,r.mdx)("li",{parentName:"ul"},"Values format: any ",(0,r.mdx)("inlineCode",{parentName:"li"},"string|binary"),"."),(0,r.mdx)("li",{parentName:"ul"},"Keys format: ",(0,r.mdx)("inlineCode",{parentName:"li"},"string")," only ",(0,r.mdx)("inlineCode",{parentName:"li"},"alphanumeric")," with ",(0,r.mdx)("inlineCode",{parentName:"li"},"-"),",",(0,r.mdx)("inlineCode",{parentName:"li"},"_"),",",(0,r.mdx)("inlineCode",{parentName:"li"},"."),".")),(0,r.mdx)("h3",{id:"quotas"},"Quotas"),(0,r.mdx)("p",null,"Quotas are limits that depend on the organization's entitlements. Every organization with App Builder access is entitled to at least 1 State quota."),(0,r.mdx)("p",null,"At the organization level, 1 quota provides:"),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},"200GB/month bandwidth usage (~5MB/min): ",(0,r.mdx)("inlineCode",{parentName:"li"},"bandwidth usage = bytes uploaded + bytes downloaded")),(0,r.mdx)("li",{parentName:"ul"},"1GB storage: ",(0,r.mdx)("inlineCode",{parentName:"li"},"storage usage = 2 * key_sizes + value_sizes"))),(0,r.mdx)("p",null,"The quota is shared for all State containers in the organization, across all regions. It is not enforced for now, just tracked."),(0,r.mdx)("p",null,(0,r.mdx)("em",{parentName:"p"},"Example: org 123 is entitled to 3 quotas, the total bandwidth usage of the organization should not exceed 600GB/month and the storage across regions should not exceed 3GB.")),(0,r.mdx)("p",null,"We also enforce rate-limiting at the State container (=Workspace) level within a region. Rate-limiting per quota unit is defined as:"),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},"10MB/min with up to 1MB/sec peaks for production Workspaces."),(0,r.mdx)("li",{parentName:"ul"},"2MB/min with up to 1MB/sec peaks for non-production Workspaces.")),(0,r.mdx)("p",null,"In case of exceeding the rate-limiting quota, the State service will return with 429s. However, a retry mechanism in the State library will mitigate the propagation of the error on short time windows."),(0,r.mdx)("p",null,(0,r.mdx)("em",{parentName:"p"},"Example: org 123 is entitled to 5 quotas, any production workspace will not be throttled before consuming 50MB/min or 5MB/sec bandwidth in a single region.")),(0,r.mdx)("h3",{id:"list-guarantees"},"List guarantees"),(0,r.mdx)("p",null,"Using ",(0,r.mdx)("inlineCode",{parentName:"p"},"state.list"),", you can iterate over the keys stored in your State container. State implements listing with a cursor-based iterator, which requires multiple calls to the State service to traverse all your keys."),(0,r.mdx)("p",null,"List provides the following guarantees:"),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},"A full iteration always returns all keys that were present in the container during the start to the end of a full iteration."),(0,r.mdx)("li",{parentName:"ul"},"A full iteration never returns any key that was deleted prior to an iteration.")),(0,r.mdx)("p",null,"However, list also has the following drawbacks:"),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},"Keys that were not constantly present in the collection during a full iteration, may be returned or not: it is undefined."),(0,r.mdx)("li",{parentName:"ul"},"In some rare cases, list may return expired keys.")),(0,r.mdx)("p",null,"Furthermore, you can control the list behavior via those two options:"),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("inlineCode",{parentName:"li"},"match"),", to filter keys using a glob-style pattern via the ",(0,r.mdx)("inlineCode",{parentName:"li"},"*")," character."),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("inlineCode",{parentName:"li"},"countHint"),", to specify an approximate amount of keys returned per iteration. State doesn't provide a guarantee on the number of elements returned per iteration, but we try (again with no guarantees) to return at least ",(0,r.mdx)("inlineCode",{parentName:"li"},"countHint")," elements per iteration.")),(0,r.mdx)("h3",{id:"troubleshooting"},"Troubleshooting"),(0,r.mdx)("p",null,"Set ",(0,r.mdx)("inlineCode",{parentName:"p"},"DEBUG=@adobe/aio-lib-state*")," to see debug logs."),(0,r.mdx)("h2",{id:"files"},"Files"),(0,r.mdx)("p",null,(0,r.mdx)("em",{parentName:"p"},"Files is currently implemented as an abstraction layer over Azure Blob. Major changes and additional features are planned, stay tuned.")),(0,r.mdx)("p",null,"To learn more please visit the ",(0,r.mdx)("a",{parentName:"p",href:"https://github.com/adobe/aio-lib-files?tab=readme-ov-file#adobe-io-lib-files"},"Adobe I/O File Storage library")," repository."),(0,r.mdx)("h2",{id:"feature-matrix"},"Feature Matrix"),(0,r.mdx)("table",null,(0,r.mdx)("thead",{parentName:"table"},(0,r.mdx)("tr",{parentName:"thead"},(0,r.mdx)("th",{parentName:"tr",align:null}),(0,r.mdx)("th",{parentName:"tr",align:null},"Files"),(0,r.mdx)("th",{parentName:"tr",align:null},"State"),(0,r.mdx)("th",{parentName:"tr",align:null},"State Legacy"))),(0,r.mdx)("tbody",{parentName:"table"},(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},"read ",(0,r.mdx)("br",null)," write ",(0,r.mdx)("br",null)," delete"),(0,r.mdx)("td",{parentName:"tr",align:null},"Y"),(0,r.mdx)("td",{parentName:"tr",align:null},"Y"),(0,r.mdx)("td",{parentName:"tr",align:null},"Y")),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},"list"),(0,r.mdx)("td",{parentName:"tr",align:null},"Y"),(0,r.mdx)("td",{parentName:"tr",align:null},"Y"),(0,r.mdx)("td",{parentName:"tr",align:null},"N")),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},"streams"),(0,r.mdx)("td",{parentName:"tr",align:null},"Y"),(0,r.mdx)("td",{parentName:"tr",align:null},"N"),(0,r.mdx)("td",{parentName:"tr",align:null},"N")),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},"copy"),(0,r.mdx)("td",{parentName:"tr",align:null},"Y"),(0,r.mdx)("td",{parentName:"tr",align:null},"N"),(0,r.mdx)("td",{parentName:"tr",align:null},"N")),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},"deleteAll"),(0,r.mdx)("td",{parentName:"tr",align:null},"N"),(0,r.mdx)("td",{parentName:"tr",align:null},"Y"),(0,r.mdx)("td",{parentName:"tr",align:null},"N")),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},"sharing"),(0,r.mdx)("td",{parentName:"tr",align:null},"Y (pre-sign URLs)"),(0,r.mdx)("td",{parentName:"tr",align:null},"N"),(0,r.mdx)("td",{parentName:"tr",align:null},"N")),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},"Time-To-Live"),(0,r.mdx)("td",{parentName:"tr",align:null},"N"),(0,r.mdx)("td",{parentName:"tr",align:null},"Y"),(0,r.mdx)("td",{parentName:"tr",align:null},"Y")),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},"max TTL"),(0,r.mdx)("td",{parentName:"tr",align:null},"infinite"),(0,r.mdx)("td",{parentName:"tr",align:null},"365 days"),(0,r.mdx)("td",{parentName:"tr",align:null},"infinite")),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},"max file/value size"),(0,r.mdx)("td",{parentName:"tr",align:null},"200GB"),(0,r.mdx)("td",{parentName:"tr",align:null},"1MB"),(0,r.mdx)("td",{parentName:"tr",align:null},"2MB")),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},"max key size"),(0,r.mdx)("td",{parentName:"tr",align:null},"1KB"),(0,r.mdx)("td",{parentName:"tr",align:null},"1KB"),(0,r.mdx)("td",{parentName:"tr",align:null},"1KB")),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},"key charset"),(0,r.mdx)("td",{parentName:"tr",align:null},"open"),(0,r.mdx)("td",{parentName:"tr",align:null},(0,r.mdx)("inlineCode",{parentName:"td"},"alphanumeric")," with ",(0,r.mdx)("inlineCode",{parentName:"td"},"_-.")),(0,r.mdx)("td",{parentName:"tr",align:null},"any but ",(0,r.mdx)("inlineCode",{parentName:"td"},"/\\?#"))),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},"max request load"),(0,r.mdx)("td",{parentName:"tr",align:null},"500 req/min ",(0,r.mdx)("br",null),"(per blob)"),(0,r.mdx)("td",{parentName:"tr",align:null},"10MB/min, 1MB/s ",(0,r.mdx)("br",null),"(scalable)"),(0,r.mdx)("td",{parentName:"tr",align:null},"900 RU/min (~KB/min)")),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},"max storage"),(0,r.mdx)("td",{parentName:"tr",align:null},"N/A"),(0,r.mdx)("td",{parentName:"tr",align:null},"1GB (scalable)"),(0,r.mdx)("td",{parentName:"tr",align:null},"10GB")),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},"regions"),(0,r.mdx)("td",{parentName:"tr",align:null},"East US ",(0,r.mdx)("br",null)," West US read-only"),(0,r.mdx)("td",{parentName:"tr",align:null},"Amer",(0,r.mdx)("br",null),"Emea (EU)",(0,r.mdx)("br",null)," ",(0,r.mdx)("em",{parentName:"td"},"Apac (coming soon)")),(0,r.mdx)("td",{parentName:"tr",align:null},"East US ",(0,r.mdx)("br",null)," Europe read-only")),(0,r.mdx)("tr",{parentName:"tbody"},(0,r.mdx)("td",{parentName:"tr",align:null},"consistency"),(0,r.mdx)("td",{parentName:"tr",align:null},"strong"),(0,r.mdx)("td",{parentName:"tr",align:null},"strong"),(0,r.mdx)("td",{parentName:"tr",align:null},"eventual")))))}p.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-guides-application-state-md-27b6bc87bb561bb0ed44.js.map